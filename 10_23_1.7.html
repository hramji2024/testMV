<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedVet by HFR and CJS</title>
    <style>
     body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: aliceblue;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 20px 50px;
            border-radius: 20px;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 80%;
            padding: 2px;
            border-radius: 2px;
            
        }

        button {
            margin: 5px 5px;
            font-size: 12px;
            padding: 8px 30px;
        }

        .glow-button {
            font-size: 12px;
            padding: 8px 30px;
            color: #fff;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .glow-button:hover {
            background-color: #0056b3;
        }

        .glow-button:click{
            background-color: #013974
        }
        .glow-button:hidden{
            display: none;
        }
        .hidden {
            display: none;
        }

    </style>
</head>
<body>
    <div class="container">
    <h1>MV 2024</h1>
    <h4><mark>Disclaimer: This tool is not meant to replace thorough daily medicine reconciliation for your patients.</mark></h4>
    <h4>Please be sure to use the correct format. The list should be left justified, numbered - 1), 2), etc.</h4>
    <h5>Example Medicine: 1)   ACETAMINOPHEN TAB  1000MG PO QID PRN                   ACTIVE</h5>
    <h5>Example Output: ACETAMINOPHEN 1000MG QID PRN</h5>
    <textarea id="input" rows="10" cols="15" placeholder="Copy and paste the INPATIENT medication list from your progress note here, starting with the 1) medicine"></textarea><br>
    <button class="glow-button" id="medRecButton" onclick="extractInfo()">Med Rec!</button>
    <button onclick="clearFields()">Clear</button>
    <h2>Medicine Names, Doses, and Schedules</h2>
    <textarea id="output" rows="10" placeholder="After you click Med Rec! the medicine names, doses, and schedules will appear here" ></textarea><br>
    <button class = "glow-button" id="copyButton" onclick="copyOutput()">Copy</button>
    <br>
    <button onclick="toLowerCase()">Lowercase</button>
    <button onclick="toUpperCase()">Uppercase</button>
    <button onclick="toSentenceCase()">Sentence Case</button>
    <h2>Medicine Count</h2>
    <textarea id="countOutput" rows="1" readonly></textarea><br><br>
    <label><input type="checkbox" id="showPrnCheckbox" onchange="togglePrnOutput()"> Show just PRN Medications</label>
    <h2 id="prnTitle" class="hidden">PRN Medications</h2>
    <textarea id="prnOutput" rows="15" class="hidden"></textarea><br>
    <button class = "glow-button hidden" id="copyButtonPRN" onclick="copyOutputPRN()">Copy PRN Meds</button>
    <h2 id="prnCountTitle" class="hidden">PRN Medication Count</h2>
    <textarea id="countPRNOutput" rows="1" readonly class="hidden"></textarea>
    <h3> Do not forget to double check the output and Medicine Count against your orders.</h3> 
    <h3>If you have any feedback or suggestions, please email hramji@tulane.edu.</h3>
    <h5>Created by Husayn F. Ramji, MD and Charles J. Santos, MD</h5>
    <h5> Version 1.7</h5>
    <input type="hidden" name="All Rights belong to Husayn F. Ramji, MD and Charles J. Santos, MD" id="hiddenField">

    </body>
    
    </div>
    <script>
 const textArea = document.getElementById('input');
        const button = document.getElementById('medRecButton');
        const button2 = document.getElementById('copyButton');
        const prnOutput = document.getElementById('prnOutput');
        const showPrnCheckbox = document.getElementById('showPrnCheckbox');
    
        const specialCases = {
            "DICLOFENAC": "DICLOFENAC",
            "INSULIN SLIDING SCALE": "INSULIN SSI",
            "SLIDING SCALE": "INSULING SSI",
            "INSULIN ASPART": "INSULIN ASPART",
            "INSULIN GLARGINE": "INSULIN GLARGINE",
            "ACCU-CHEK": "ACCU-CHECK STRIPS",
            "ALCOHOL PREP PAD": "ALCOHOL PADS",
            "HEPARIN NA 5000 UNT": "SQH 5000",
            "HYDROPHILIC EUCERIN": "EUCERIN CREAM",
            "LIDOCAINE OINT": "LIDOCAINE CREAM",
            "LIDOCAINE PATCH": "LIDOCAINE PATCH",
            "LATANOPROST": "GLAUCOMA EYE DROPS",
            "MULTIVITAMIN": "MULTIVITAMIN",
            "DORZOLAMIDE": "GLAUCOMA EYE DROPS",
            "LOTION": "MEDICINAL LOTION",
            "LIDOCAINE PATCH": "LIDOCAINE PATCH",
            "TIMOLOL": "GLAUCOMA EYE DROPS",
            "CALAMINE": "CALAMINE",
            "KETOCONAZOLE": "KETOCONAZOLE",
            "NASAL SPRAY": "NASAL SPRAY",
            "PREDNISOLONE OPH": "STEROID EYE DROPS",
            "CLOTRIMAZOLE": "CLOTRIMAZOLE"
        };
    
        function extractInfo() {
            const input = document.getElementById('input').value;
            const lines = input.split('\n');
            const results = [];
            let currentLine = '';
    
            lines.forEach(line => {
                if (/^\d+\)/.test(line)) {
                    if (currentLine) {
                        // Process the accumulated line
                        processLine(currentLine, results);
                    }
                    // Start a new line
                    currentLine = line.trim();
                } else {
                    // Accumulate the line if it doesn't start with a number
                    currentLine += ' ' + line.trim();
                }
            });
    
            // Process the last accumulated line
            if (currentLine) {
                processLine(currentLine, results);
            }
    
            // Displaying the extracted names, doses, and schedules in the output textarea
            document.getElementById('output').value = results.join('\n');
            document.getElementById('countOutput').value = results.length;

            // Filter PRN medications and display them
            const prnMeds = results.filter(entry => entry.includes('PRN'));
            prnOutput.value = prnMeds.join('\n');
            document.getElementById('countPRNOutput').value = prnMeds.length;
    
            // Check if the output textarea has content
            if (results.length > 0) {
                button2.classList.add('active');
            } else {
                button2.classList.remove('active');
            }
        }
    
        function processLine(line, results) {
            for (let key in specialCases) {
                if (new RegExp(key).test(line)) {
                    results.push(specialCases[key]);
                    return;
                }
            }
    
            // Regex to handle various dosing formats, including names with '/'
            const match = line.match(/^\d+\)\s+(.+?)\s+(\d+(\.\d+)?%?\s*(?:MG|ML|MCG|GM|GRAMS|CREAM|PATCHES|PATCH|ORAL PWDR|SOLN,TOP|TOP|UNT|UNIT|ML\/ML|SC))\s+([A-Z]+)\s+(BID|TID|QID|DAILY|QAM|QPM|Q12H|Q15MIN|PRN|ONCE|QHS|Q1H|Q2H|Q4H|Q8H|Q6H|QDAY)/i);
            if (match) {
                let medicine = match[1].replace(/\b(TAB|CAP|ORAL|HCL|SOLN|CHEWABLE|INHL|INJ|EC|ORAL PWDR|SOLN,TOP|TOP|QUEtiapine|SUSP|XTRA|NEB|RT|STRENGTH|NA|UN|UNT|INJ|PEG TUBE|PWDR,RENST)\b/g, '').trim();
                const dose = match[2].trim();
                let schedule = match[5].trim();
                // Remove commas from medicine name if present
                medicine = medicine.replace(/,$/, '').trim();
                // Check if the line contains "PRN"
                if (/PRN/i.test(line) || /AS NEEDED/i.test(line)) {
                    schedule += " PRN";
                }
    
                const entry = `${medicine} ${dose} ${schedule}`;
                results.push(entry);
            } else {
                // Handle cases where regex does not match
                handleSpecialCases(line, results);
            }
        }
    
        function handleSpecialCases(line, results) {
            // Attempt to extract doses from cases where the main regex fails
            const specialMatch = line.match(/^\d+\)\s+(.+?)\s+([\d\.]+%?[\w\/]+(?:\s[\w\/]+)*)/i);
            if (specialMatch) {
                let medicine = specialMatch[1].replace(/\b(TAB|CAP|ORAL|HCL|SOLN|CHEWABLE|INHL|INJ|EC|QUEtiapine|SOLN,TOP|TOP|NA|UN|UNT|INJ)\b/g, '').trim();
                const dose = specialMatch[2].trim();
                // Remove commas from medicine name if present
                medicine = medicine.replace(/,$/, '').trim();
                results.push(`${medicine} ${dose}`);
            }
        }
    
        function clearFields() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
            prnOutput.value = '';
            document.getElementById('countOutput').value = '';
            button.classList.remove('active');
            button2.classList.remove('active');
            document.getElementById('countPRNOutput').value = '';
        }
    
        function copyOutput() {
            const outputText = document.getElementById('output');
            outputText.select();
            outputText.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');
            button2.classList.remove('active');
        }

        function copyOutputPRN() {
            const outputText = document.getElementById('prnOutput');
            outputText.select();
            outputText.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');
        }

        function togglePrnOutput() {
            if (showPrnCheckbox.checked) {
                prnOutput.classList.remove('hidden');
                countPRNOutput.classList.remove('hidden')
                prnTitle.classList.remove('hidden');
                prnCountTitle.classList.remove('hidden');
                copyButtonPRN.classList.remove('hidden');
            } else {
                prnOutput.classList.add('hidden');
                countPRNOutput.classList.add('hidden')
                prnTitle.classList.add('hidden');
                prnCountTitle.classList.add('hidden');
                copyButtonPRN.classList.add('hidden');
            }
        }
        function toLowerCase() {
             const outputText = document.getElementById('output').value;  // Get text from the output box
             document.getElementById('output').value = outputText.toLowerCase();  // Convert output text to lowercase
        }

        function toUpperCase() {
            let input = document.getElementById("output").value;
            document.getElementById("output").value = input.toUpperCase();
        }

        function toSentenceCase() {
            const outputText = document.getElementById('output').value;
            let lines = outputText.split('\n');  // Split text by line breaks
    
            for (let i = 0; i < lines.length; i++) {
                lines[i] = lines[i].charAt(0).toUpperCase() + lines[i].slice(1).toLowerCase();  // Apply sentence case to each line
            }
            
            document.getElementById('output').value = lines.join('\n');  // Join lines back and set it in the output
        }
    
        textArea.addEventListener('input', () => {
            if (textArea.value.trim()) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    
        button.addEventListener('click', () => {
            button.classList.remove('active');
            extractInfo(); // Ensure extractInfo is called to update the output
        });
    
        button2.addEventListener('click', () => {
            button2.classList.remove('active');
            copyOutput(); // Ensure the copy function is called
        });
    </script>
    
</html>
